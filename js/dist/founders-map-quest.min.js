/*! founders-map-quest 08-07-2015 */
var app=app||{};app.ColumnModel=Backbone.Model.extend({initialize:function(a){void 0!==a&&this.set("name",a)},defaults:function(){return{name:""}},getName:function(){return this.get("name")}});var app=app||{};app.ErrorModel=Backbone.Model.extend({defaults:function(){return{message:""}}});var app=app||{};app.RowModel=Backbone.Model.extend({initialize:function(a){var b=this;b.set("hide",!1),b.set(a)},toggle:function(){var a=this;a.set("hide",!a.get("hide")),a.get("hide")?a.hideMarker():a.showMarker()},isHidden:function(){return this.get("hide")},hideMarker:function(){var a=this,b=a.get("googleMarker");b.setMap(null)},showMarker:function(){var a=this,b=a.get("googleMarker");b.setMap(a.get("googleMap"))},createGoogleMarker:function(a,b,c,d){var e,f=this,g="";"empty"!==c&&(g+=f.get(c)),e=new google.maps.Marker({position:new google.maps.LatLng(f.get(a),f.get(b)),map:d,title:g}),f.set("googleMap",d),f.set("googleMarker",e)}});var app=app||{};app.ColumnCollection=Backbone.Collection.extend({model:app.ColumnModel});var app=app||{};app.RowCollection=Backbone.Collection.extend({model:app.RowModel,originalRowArray:void 0,sortBy:function(a){var b=this,c=_.sortBy(b.originalRowArray,a);b.reset(c)},filter:function(a,b){var c=this,d=_.filter(c.originalRowArray,function(c){return-1!==c[a].toUpperCase().indexOf(b.toUpperCase())});c.reset(d)},setData:function(a){var b=this;b.originalRowArray=a,b.each(function(a){a.hideMarker()}),b.reset(a)},removeFilter:function(){this.reset(this.originalRowArray)}});var app=app||{};app.ErrorView=Backbone.View.extend({initialize:function(){this.template=_.template($("#error-template").html())},render:function(){var a=this;return a.$el.html(a.template(a.model.toJSON())),a}});var app=app||{};app.FileView=Backbone.View.extend({el:"#main",events:{"click #button-file-chooser":"openFileChooser","change #file-chooser":"processFile","click #show-results-button":"showResults","click #filter-button":"filterRows","click #remove-filter-button":"removeFilter","click #sort-button":"sortRows","click #begin-again-button":"beginAgain","click #go-back-beginning-button":"beginAgain","click #go-back-button":"goBack"},initialize:function(a){var b=this;b.$stepsRow=b.$("#steps-row"),b.$selectFileRow=b.$("#select-file-row"),b.$columnSelectionRow=b.$("#column-selection-row"),b.$resultRow=b.$("#result-row"),b.$errorRow=b.$("#error-row"),b.$fileChooser=b.$("#file-chooser"),b.$mapElement=b.$("#map-canvas"),b.$table=b.$("#table-places"),b.map=void 0,b.listenTo(app.Rows,"add",b.addRow),b.listenTo(app.Rows,"reset",b.addAllRows),b.$columnSelectionRow.hide(),b.$resultRow.hide()},openFileChooser:function(){var a=this;a.$errorRow.html(""),a.$fileChooser.click()},processFile:function(){var a,b=this.$fileChooser.val(),c=this;""!==b&&(a=c.$fileChooser[0].files[0],c.setDataFromFile(a),c.$fileChooser[0].value=null)},setDataFromFile:function(a){var b=this;"text/csv"!==a.type&&b.showTypeError(),0===a.size&&b.showNoDataError(),"text/csv"===a.type&&a.size>0&&Papa.parse(a,{header:!0,complete:function(a){a.errors.length>0?b.showParsingError():(b.$table.html(""),app.Columns.reset(a.meta.fields),app.Rows.setData(a.data),b.showSelectOptions())}})},showSelectOptions:function(){var a=this;a.setDropdownListValues("#dropdown-latitude",!1),a.setDropdownListValues("#dropdown-longitude",!1),a.setDropdownListValues("#dropdown-marker",!0),a.$selectFileRow.hide(),a.$columnSelectionRow.show(),a.$errorRow.html("")},setDropdownListValues:function(a,b){var c=this,d=c.$(a);void 0!==d[0].options&&(d[0].options.length=0),b&&d.append(new Option("","empty")),app.Columns.each(function(a){d.append(new Option(a.getName(),a.getName()))}),d[0].options[0].selected=!0},showResults:function(){var a,b=this;b.latitudeColumn=b.$("#dropdown-latitude").val(),b.longitudeColumn=b.$("#dropdown-longitude").val(),b.markerColumn=b.$("#dropdown-marker").val(),b.latitudeColumn!==b.longitudeColumn?(b.setDropdownListValues("#dropdown-sort",!1),b.setDropdownListValues("#dropdown-filter",!1),b.$errorRow.html(""),b.$columnSelectionRow.hide(),b.$resultRow.show(),a=b.getMapCenter(b.latitudeColumn,b.longitudeColumn),b.initialiseMap(a),b.createMapMarkers(b.latitudeColumn,b.longitudeColumn,b.markerColumn,b.map)):b.showEqualLatitudeLongitudeValues()},createMapMarkers:function(a,b,c,d){app.Rows.each(function(e){e.createGoogleMarker(a,b,c,d)})},initialiseMap:function(a){var b=document.getElementById("map-canvas"),c={center:a,zoom:10,mapTypeId:google.maps.MapTypeId.ROADMAP};this.map=new google.maps.Map(b,c)},getMapCenter:function(a,b){var c=app.Rows.at(0).get(a),d=app.Rows.at(0).get(b),e=new google.maps.LatLng(c,d);return e},addAllRows:function(){this.$table.html(""),app.Rows.each(this.addRow,this)},addRow:function(a){var b=new app.RowView({model:a});this.$table.append(b.render().el)},filterRows:function(){var a=this,b=a.$("#dropdown-filter").val(),c=a.$("#filter-value").val();app.Rows.filter(b,c),a.createMapMarkers(a.latitudeColumn,a.longitudeColumn,a.markerColumn,a.map)},sortRows:function(){var a=this,b=a.$("#dropdown-sort").val();app.Rows.sortBy(b),a.createMapMarkers(a.latitudeColumn,a.longitudeColumn,a.markerColumn,a.map)},removeFilter:function(){var a=this;a.$("#dropdown-filter").val(""),a.$("#filter-value").val(""),app.Rows.removeFilter(),a.createMapMarkers(a.latitudeColumn,a.longitudeColumn,a.markerColumn,a.map)},beginAgain:function(a){var b=this;b.$columnSelectionRow.hide(),b.$resultRow.hide(),b.$selectFileRow.show()},goBack:function(){var a=this;a.$resultRow.hide(),a.$selectFileRow.hide(),a.$columnSelectionRow.show()},showTypeError:function(){var a=new app.ErrorModel({message:"Looks like it's the wrong file format, make sure it's a .csv"}),b=new app.ErrorView({model:a}),c=this;c.$errorRow.append(b.render().el)},showNoDataError:function(){var a=new app.ErrorModel({message:"Looks like the file is empty, please upload another file"}),b=new app.ErrorView({model:a}),c=this;c.$errorRow.append(b.render().el)},showParsingError:function(){var a=new app.ErrorModel({message:"Looks like there's a problem processing the file, please try with another file"}),b=new app.ErrorView({model:a}),c=this;c.$errorRow.append(b.render().el)},showEqualLatitudeLongitudeValues:function(){var a=new app.ErrorModel({message:"Looks like you have selected the same column for latitude and longitude"}),b=new app.ErrorView({model:a}),c=this;c.$errorRow.append(b.render().el)}});var app=app||{};app.RowView=Backbone.View.extend({events:{"click #toggle":"toggleMarker"},initialize:function(){this.template=_.template($("#row-template").html())},render:function(){var a=this;return a.$el.html(a.template()),_.each(a.model.toJSON(),function(b,c){var d,e,f;"hide"!==c&&(a.$el.find("#data-table").append($("<tr>").append($("<td>").text(c)).append($("<td>"))),d=a.$el.find("#data-table").find("tr").last().find("td").last(),e="http"===b.substring(0,4),f=b.substring(b.length-3),e&&(d.append($("<a>").attr("href",b).attr("target","_blank")),d=d.find("a")),"jpg"===f||"png"===f||"gif"===f?d.append($("<img>").attr("src",b).attr("class","img-thumbnail").text(b)):d.text(b))}),a},toggleMarker:function(){this.model.toggle()}});var app=app||{};app.Rows=new app.RowCollection,app.Columns=new app.ColumnCollection,$(function(){new app.FileView});